<script>
    const CLUSTER_URL = 'https://api.mainnet-beta.solana.com'; // Configurado para Mainnet
    const connectWalletBtn = document.getElementById('connectWallet');
    const burnButton = document.getElementById('burnButton');
    const walletAddress = document.getElementById('walletAddress');
    const mintIdInput = document.getElementById('mintId');
    const amountInput = document.getElementById('amount');
    const status = document.getElementById('status');
    const error = document.getElementById('error');
    
    let walletPublicKey = null;
    const connection = new solanaWeb3.Connection(CLUSTER_URL, 'confirmed');

    // Conectar wallet
    connectWalletBtn.onclick = async () => {
        if (!window.solana) {
            error.textContent = 'Instala Phantom u otra wallet compatible.';
            return;
        }
        try {
            const response = await window.solana.connect();
            walletPublicKey = new solanaWeb3.PublicKey(response.publicKey.toString());
            walletAddress.textContent = `Wallet conectada: ${walletPublicKey}`;
            burnButton.disabled = false;
            connectWalletBtn.disabled = true;
        } catch (err) {
            error.textContent = 'Error al conectar wallet: ' + err.message;
        }
    };

    // Quemar tokens
    burnButton.onclick = async () => {
        const mintStr = mintIdInput.value.trim();
        const amountStr = amountInput.value.trim();
        if (!mintStr || !amountStr) {
            error.textContent = 'Ingresa una mint y cantidad válidas.';
            return;
        }
        status.textContent = 'Procesando...';
        error.textContent = '';

        try {
            const mint = new solanaWeb3.PublicKey(mintStr);
            const amount = parseFloat(amountStr);

            // Fetch info de mint (decimales)
            const mintInfo = await splToken.getMint(connection, mint);
            const decimals = mintInfo.decimals;
            const burnAmount = BigInt(Math.floor(amount * Math.pow(10, decimals))); // Ajusta a unidades mínimas

            // Derivar ATA
            const tokenAccount = await splToken.getAssociatedTokenAddress(mint, walletPublicKey);

            // Crear instrucción de quema
            const burnIx = splToken.createBurnCheckedInstruction(
                tokenAccount,
                mint,
                walletPublicKey,
                burnAmount,
                decimals
            );

            // Crear transacción
            const transaction = new solanaWeb3.Transaction().add(burnIx);

            // Obtener blockhash y lastValidBlockHeight
            const { blockhash, lastValidBlockHeight } = await connection.getLatestBlockhash('confirmed');
            transaction.recentBlockhash = blockhash;
            transaction.feePayer = walletPublicKey;

            // Firmar
            const signedTransaction = await window.solana.signTransaction(transaction);

            // Enviar y confirmar
            const signature = await connection.sendRawTransaction(signedTransaction.serialize());
            await connection.confirmTransaction({
                signature,
                blockhash,
                lastValidBlockHeight
            });

            status.textContent = `¡Tokens quemados! Firma: ${signature}`;
        } catch (err) {
            error.textContent = 'Error: ' + err.message;
            console.error(err);
        }
    };
</script>